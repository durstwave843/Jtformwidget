<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script>
      console.log("üèÅ widget HTML loaded");
      
      // Global variables to store state
      var checkboxValues = [];
      var qid = "";
      var formID = "";
      
      // Initialize when the widget is ready
      JFCustomWidget.subscribe("ready", function() {
        console.log("üîî widget ready fired");
        document.getElementById("status").textContent = "Connected to JotForm";
        
        // Get form ID and question ID from widget parameters
        var widgetData = JFCustomWidget.getWidgetSettings();
        qid = new URLSearchParams(window.location.search).get('qid') || "";
        
        console.log("Widget settings:", widgetData);
        console.log("Question ID:", qid);
        
        // Set up form submission handler
        JFCustomWidget.subscribe("submit", function() {
          console.log("Form submit detected");
          JFCustomWidget.sendSubmit({
            valid: true,
            value: checkboxValues.join(", ")
          });
        });
        
        // Set up listener specifically for the checkbox group in your form
        setupCheckboxListener();
        
        // Display initial message
        document.getElementById("selections").innerHTML = "<p>Waiting for checkbox selections...</p>";
        document.getElementById("selections").style.display = "block";
      });
      
      // Set up a listener for the checkbox field (q3_typeA)
      function setupCheckboxListener() {
        // IDs to try based on your form structure
        var fieldIds = [
          "input_3_0",    // First checkbox Asphalt
          "input_3_1",    // Second checkbox Metal
          "input_3_2"     // Third checkbox Tile
        ];
        
        // Set up a parent form value change listener
        JFCustomWidget.subscribe("formValueChanged", function(data) {
          console.log("Form value changed:", data);
          
          // Check if this is our checkbox field
          if (data && data.fieldID && data.fieldID.indexOf("q3_typeA") !== -1) {
            console.log("Checkbox field changed:", data);
            updateTextFieldValue();
          }
          
          // Also directly check for the piped text field
          if (data && data.fieldID && data.fieldID.indexOf("q10_typeA10") !== -1) {
            console.log("Text field changed:", data);
            processTextFieldValue(data.value);
          }
        });
        
        // Use listenFromField for the specific field
        JFCustomWidget.listenFromField("q3_typeA", "change", function(value) {
          console.log("Checkbox value changed:", value);
          updateTextFieldValue();
        });
        
        // Listen for the text field value that contains the piped checkbox values
        JFCustomWidget.listenFromField("q10_typeA10", "change", function(value) {
          console.log("Text field value changed:", value);
          processTextFieldValue(value);
        });
        
        // Direct polling for textbox field
        startPollingForTextValue();
      }
      
      // Poll for text field value since other methods might not work
      function startPollingForTextValue() {
        var pollCounter = 0;
        
        var pollInterval = setInterval(function() {
          pollCounter++;
          console.log("Polling attempt #" + pollCounter);
          
          if (pollCounter > 30) {
            clearInterval(pollInterval);
            console.log("Polling stopped after 30 attempts");
            return;
          }
          
          // Try to get the value from the text field
          var fieldIds = ["q10_typeA10", "input_10"];
          
          fieldIds.forEach(function(fieldId) {
            JFCustomWidget.getFieldsValueByName([fieldId], function(response) {
              console.log("Polling result for " + fieldId + ":", response);
              
              if (response && response.data !== undefined) {
                processTextFieldValue(response.data);
              }
            });
          });
        }, 3000);
      }
      
      // Update the text field with current checkbox values
      function updateTextFieldValue() {
        // This function attempts to read the checkboxes and update the text field
        // However, we can't directly access parent form elements from the iframe
        // Rely on the form's conditions to populate the text field instead
        console.log("Checkbox values may have changed - waiting for text field update");
      }
      
      // Process the text field value that contains comma-separated checkbox values
      function processTextFieldValue(value) {
        if (!value) {
          updateDisplay("No checkboxes selected", []);
          return;
        }
        
        // Convert to string and split by comma
        var textValue = String(value);
        checkboxValues = textValue.split(',').map(function(item) {
          return item.trim();
        }).filter(function(item) {
          return item !== '';
        });
        
        // Update the display
        updateDisplay("Selected items:", checkboxValues);
        console.log("‚úÖ Parsed checkbox values:", checkboxValues);
      }
      
      // Update the display with the checkbox values
      function updateDisplay(title, values) {
        var html = "<strong>" + title + "</strong>";
        
        if (values.length > 0) {
          html += "<ul>" + 
            values.map(function(val) {
              return "<li>" + val + "</li>";
            }).join("") + 
            "</ul>";
        } else {
          html += "<p>No items selected</p>";
        }
        
        document.getElementById("selections").innerHTML = html;
        document.getElementById("selections").style.display = "block";
      }
    </script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 12px;
        margin: 0;
        background-color: #f9f9f9;
      }
      #status {
        padding: 8px;
        background-color: #e8f5e9;
        border-radius: 4px;
        border-left: 4px solid #4caf50;
        margin-bottom: 10px;
        font-weight: bold;
      }
      #selections {
        padding: 8px;
        background-color: #fff;
        border-radius: 4px;
        border: 1px solid #ddd;
        margin: 10px 0;
        word-break: break-all;
        display: none;
      }
      #selections ul {
        margin: 5px 0;
        padding-left: 20px;
      }
      #selections li {
        margin-bottom: 4px;
      }
      .note {
        font-size: 12px;
        color: #666;
        margin-top: 12px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div id="status">Connecting to JotForm...</div>
    <div id="selections"></div>
    <div class="note">
      This widget displays the checkbox selections from the form.
      <br>
      It reads values from the text field (q10_typeA10) which is automatically populated by the form's calculation.
    </div>
  </body>
</html>
