<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <!-- Load the Widget API -->
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script>
      console.log("üèÅ widget HTML loaded");
      
      // Initialize the widget when ready
      JFCustomWidget.subscribe("ready", function() {
        console.log("üîî widget ready fired");
        document.getElementById("status").textContent = "Connected to JotForm";
        
        // Get question ID from URL parameters
        var urlParams = new URLSearchParams(window.location.search);
        var qid = urlParams.get('qid');
        console.log("Widget question ID:", qid);
        
        // Target the piped text field with name typeA10
        var targetFieldNames = [
          "typeA10",               // Basic field name
          "q" + qid + "_typeA10",  // With question ID
          "input_typeA10",         // Input prefix
          "input_" + qid           // Input with question ID
        ];
        
        console.log("Will try these field names:", targetFieldNames);
        
        // Listen for initial form data
        JFCustomWidget.getFormData(function(data) {
          console.log("Initial form data:", data);
        });
        
        // Set up listeners for each possible field name
        targetFieldNames.forEach(function(fieldName) {
          console.log("Setting up listener for:", fieldName);
          
          // Listen for changes to the piped text field
          JFCustomWidget.listenFromField(fieldName, "change", function(value) {
            console.log("‚úÖ Field change detected on " + fieldName + ":", value);
            processTextFieldValue(fieldName, value);
          });
        });
        
        // Also listen for form value changes to catch the piped field
        JFCustomWidget.subscribe("formValueChanged", function(data) {
          console.log("Form value changed:", data);
          
          if (data && data.fieldID) {
            // Check if the changed field matches any of our target names
            var isTargetField = targetFieldNames.some(function(name) {
              return data.fieldID.includes(name);
            });
            
            if (isTargetField) {
              console.log("‚úÖ Target field changed:", data.fieldID, "=", data.value);
              processTextFieldValue(data.fieldID, data.value);
            }
          }
          
          // As a fallback, get all values
          JFCustomWidget.getAllFormValues(function(response) {
            if (response && response.formData) {
              console.log("All form values:", response.formData);
              
              // Look for our field in all form data
              for (var key in response.formData) {
                var isTargetField = targetFieldNames.some(function(name) {
                  return key.includes(name);
                });
                
                if (isTargetField) {
                  console.log("‚úÖ Found target field in form data:", key, "=", response.formData[key]);
                  processTextFieldValue(key, response.formData[key]);
                }
              }
            }
          });
        });
        
        // Process the comma-separated text value from the field
        function processTextFieldValue(fieldName, value) {
          if (!value) {
            updateDisplay("No checkboxes selected", []);
            return;
          }
          
          // Convert to string if it's not already
          var textValue = String(value);
          
          // Split by comma and trim each value
          var selectedValues = textValue.split(',').map(function(item) {
            return item.trim();
          }).filter(function(item) {
            return item !== '';
          });
          
          // Update the display
          updateDisplay("Selections from " + fieldName, selectedValues);
          
          // Log the parsed values
          console.log("Parsed checkbox values:", selectedValues);
        }
        
        // Update the display with the checkbox values
        function updateDisplay(title, values) {
          var html = "<strong>" + title + ":</strong>";
          
          if (values.length > 0) {
            html += "<ul>" + 
              values.map(function(val) {
                return "<li>" + val + "</li>";
              }).join("") + 
              "</ul>";
          } else {
            html += "<p>No items selected</p>";
          }
          
          document.getElementById("fieldStatus").style.display = "block";
          document.getElementById("fieldStatus").innerHTML = html;
        }
      });
      
      // Handle form submission
      JFCustomWidget.subscribe("submit", function() {
        console.log("üîî widget submit fired");
        var fieldContent = document.getElementById("fieldStatus").innerHTML || "No selection";
        JFCustomWidget.sendSubmit({
          valid: true,
          value: fieldContent
        });
      });
    </script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 12px;
        margin: 0;
      }
      #status {
        padding: 8px;
        background-color: #f0f0f0;
        border-radius: 4px;
        margin-bottom: 10px;
      }
      #fieldStatus {
        padding: 8px;
        background-color: #e6f7ff;
        border-left: 4px solid #1890ff;
        margin: 10px 0;
        word-break: break-all;
        display: none;
      }
      ul {
        margin: 5px 0;
        padding-left: 20px;
      }
      .note {
        font-size: 12px;
        color: #666;
        margin-top: 12px;
      }
    </style>
  </head>
  <body>
    <div id="status">Loading‚Ä¶</div>
    <div id="fieldStatus" style="display:none;"></div>
    <div class="note">This widget is monitoring the piped text field {typeA10}. Check your browser console (F12) for detailed logs.</div>
  </body>
</html>
