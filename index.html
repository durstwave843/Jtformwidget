<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <!-- Load the Widget API correctly -->
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script>
      console.log("üèÅ widget HTML loaded");
      
      // Always subscribe to ready event first - this is the recommended pattern
      // in the JotForm documentation
      JFCustomWidget.subscribe("ready", function() {
        console.log("üîî widget ready fired");
        document.getElementById("status").textContent = "Connected to JotForm";
        
        // Get widget settings if provided
        var settings = JFCustomWidget.getWidgetSettings();
        console.log("Widget settings:", settings);
        
        // Get question ID from URL parameters
        var qid = getQuestionId();
        console.log("Widget question ID:", qid);
        
        // Target field names we want to listen to
        var targetFieldNames = [
          "typeA10",
          "q" + qid + "_typeA10",
          "input_" + qid
        ];
        
        console.log("Will try to listen to fields:", targetFieldNames);
        
        // Set up listeners for each possible field name
        targetFieldNames.forEach(function(fieldName) {
          // Use listenFromField method as documented
          JFCustomWidget.listenFromField(fieldName, "change", function(value) {
            console.log("‚úÖ Change detected on " + fieldName + ":", value);
            processValue(fieldName, value);
          });
        });
        
        // Also listen for form-wide value changes
        JFCustomWidget.subscribe("formValueChanged", function(data) {
          if (data && data.fieldID && data.value !== undefined) {
            // Check if this is our target field
            if (isTargetField(data.fieldID, targetFieldNames)) {
              console.log("‚úÖ Target field changed:", data.fieldID, "=", data.value);
              processValue(data.fieldID, data.value);
            }
          }
        });
        
        // Try using getFieldsValueByName as documented
        // This should be placed inside the ready event according to docs
        targetFieldNames.forEach(function(fieldName) {
          JFCustomWidget.getFieldsValueByName([fieldName], function(response) {
            console.log("Initial field value for " + fieldName + ":", response);
            if (response && response.data !== undefined) {
              processValue(fieldName, response.data);
            }
          });
        });
        
        // Initialize display
        updateDisplay("Waiting for typeA10 field values...", []);
      });
      
      // Handle form submission as documented in the API
      JFCustomWidget.subscribe("submit", function() {
        console.log("üîî widget submit fired");
        
        // Send back the current value using sendSubmit
        JFCustomWidget.sendSubmit({
          valid: true,
          value: document.getElementById("selections").textContent || ""
        });
      });
      
      // Helper function to get question ID from URL
      function getQuestionId() {
        var urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('qid') || "";
      }
      
      // Helper function to check if a field ID matches any of our target fields
      function isTargetField(fieldID, targetFields) {
        return targetFields.some(function(targetField) {
          return fieldID.indexOf(targetField) !== -1;
        });
      }
      
      // Process the comma-separated value from the field
      function processValue(fieldName, value) {
        if (!value) {
          updateDisplay("No checkboxes selected", []);
          return;
        }
        
        // Make sure we have a string
        var textValue = String(value);
        
        // Split by comma and clean up values
        var selectedValues = textValue.split(',').map(function(item) {
          return item.trim();
        }).filter(function(item) {
          return item !== '';
        });
        
        // Update the display
        updateDisplay("Selections from " + fieldName, selectedValues);
        
        // Log the values
        console.log("Parsed checkbox values:", selectedValues);
      }
      
      // Update the display with the checkbox values
      function updateDisplay(title, values) {
        var html = "<strong>" + title + "</strong>";
        
        if (values.length > 0) {
          html += "<ul>" + 
            values.map(function(val) {
              return "<li>" + val + "</li>";
            }).join("") + 
            "</ul>";
        } else {
          html += "<p>No items selected</p>";
        }
        
        document.getElementById("selections").style.display = "block";
        document.getElementById("selections").innerHTML = html;
      }
    </script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 12px;
        margin: 0;
        background-color: #f9f9f9;
      }
      #status {
        padding: 8px;
        background-color: #e8f5e9;
        border-radius: 4px;
        border-left: 4px solid #4caf50;
        margin-bottom: 10px;
        font-weight: bold;
      }
      #selections {
        padding: 8px;
        background-color: #fff;
        border-radius: 4px;
        border: 1px solid #ddd;
        margin: 10px 0;
        word-break: break-all;
        display: none;
      }
      #selections ul {
        margin: 5px 0;
        padding-left: 20px;
      }
      #selections li {
        margin-bottom: 4px;
      }
      .note {
        font-size: 12px;
        color: #666;
        margin-top: 12px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div id="status">Connecting to JotForm...</div>
    <div id="selections" style="display:none;"></div>
    <div class="note">This widget monitors the piped text field {typeA10} which contains your checkbox selections.</div>
  </body>
</html>
