<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <!-- Load the Widget API -->
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script>
      console.log("üèÅ widget HTML loaded");
      
      // Initialize the widget when ready
      JFCustomWidget.subscribe("ready", function() {
        console.log("üîî widget ready fired");
        document.getElementById("status").textContent = "Connected to JotForm";
        
        // Get the widget's configuration data
        var widgetData = JFCustomWidget.getWidgetSettings();
        console.log("Widget settings:", widgetData);
        
        // Get field question ID from URL parameters
        var urlParams = new URLSearchParams(window.location.search);
        var qid = urlParams.get('qid');
        console.log("Question ID from URL:", qid);
        
        // Special handling required for checkbox groups
        // We need to monitor the entire form values
        JFCustomWidget.subscribe("formData", function(formData) {
          console.log("üìù Initial form data:", formData);
          if (formData && formData.formData) {
            processFormData(formData.formData);
          }
        });
        
        // This captures ALL form value changes - crucial for checkbox groups
        JFCustomWidget.subscribe("formValueChanged", function(data) {
          console.log("üìä Form value changed event:", data);
          
          // Get all current form values after a change
          JFCustomWidget.getAllFormValues(function(response) {
            console.log("üîÑ All form values after change:", response);
            if (response && response.formData) {
              processFormData(response.formData);
            }
          });
        });
        
        // Function to find and extract checkbox values from form data
        function processFormData(formData) {
          console.log("Processing form data:", formData);
          
          // Checkboxes in JotForm are often in this format
          var possibleFieldNames = [
            "typeA",                  // Base name
            "q" + qid + "_typeA",     // With question ID prefix
            "input_" + qid + "_0",    // First checkbox in group
            qid + "_typeA"            // Alternative format
          ];
          
          // Loop through the form data and look for our field
          var checkboxValues = [];
          var fieldFound = false;
          
          for (var fieldName in formData) {
            console.log("Checking field:", fieldName);
            
            // Check if field name contains any of our possible names
            var matchesTarget = possibleFieldNames.some(function(name) {
              return fieldName.includes(name);
            });
            
            if (matchesTarget) {
              fieldFound = true;
              console.log("‚úÖ Found matching field:", fieldName, "=", formData[fieldName]);
              
              // Handle single value case
              if (typeof formData[fieldName] === 'string') {
                // For checkbox groups, JotForm often returns comma-separated values
                checkboxValues = formData[fieldName].split(',').map(function(item) {
                  return item.trim();
                }).filter(function(item) {
                  return item !== '';
                });
              } 
              // Handle array case
              else if (Array.isArray(formData[fieldName])) {
                checkboxValues = formData[fieldName];
              }
              
              // Display the values
              updateFieldDisplay(fieldName, checkboxValues);
            }
            
            // Also check if this could be a specific checkbox in the group
            if (fieldName.match(/typeA_\d+/) || fieldName.match(/q\d+_typeA_\d+/)) {
              var isChecked = formData[fieldName] === 'Yes' || formData[fieldName] === true || formData[fieldName] === 1;
              if (isChecked) {
                console.log("‚úÖ Individual checkbox checked:", fieldName);
                fieldFound = true;
                
                // Extract the option value (usually the last part after underscore)
                var optionValue = fieldName.split('_').pop();
                if (!checkboxValues.includes(optionValue)) {
                  checkboxValues.push(optionValue);
                }
                
                updateFieldDisplay(fieldName, checkboxValues);
              }
            }
          }
          
          // If we didn't find the field, update UI to show that
          if (!fieldFound) {
            document.getElementById("fieldStatus").style.display = "block";
            document.getElementById("fieldStatus").innerHTML = 
              "<strong>No matching checkbox field found.</strong><br>" +
              "Searched for: " + possibleFieldNames.join(", ") + "<br>" +
              "Available fields: " + Object.keys(formData).join(", ");
          }
          
          // Always display all form values for debugging
          document.getElementById("allValues").style.display = "block";
          document.getElementById("allValues").innerHTML = 
            "<strong>All form values:</strong><br>" + 
            "<pre>" + JSON.stringify(formData, null, 2) + "</pre>";
        }
        
        // Helper function to update the display with checkbox values
        function updateFieldDisplay(fieldName, values) {
          if (values && values.length > 0) {
            document.getElementById("fieldStatus").style.display = "block";
            document.getElementById("fieldStatus").innerHTML = 
              "<strong>Checkbox values for " + fieldName + ":</strong><br>" +
              "<ul>" + 
              values.map(function(val) {
                return "<li>" + val + "</li>";
              }).join("") + 
              "</ul>";
            
            console.log("‚úÖ Checkbox values:", values);
          } else {
            document.getElementById("fieldStatus").style.display = "block";
            document.getElementById("fieldStatus").innerHTML = 
              "<strong>Field " + fieldName + " found but no checkboxes selected.</strong>";
          }
        }
      });
      
      // Handle form submission
      JFCustomWidget.subscribe("submit", function() {
        console.log("üîî widget submit fired");
        JFCustomWidget.sendSubmit({
          valid: true,
          value: document.getElementById("fieldStatus").textContent || "No selection"
        });
      });
    </script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 12px;
        margin: 0;
      }
      #status {
        padding: 8px;
        background-color: #f0f0f0;
        border-radius: 4px;
        margin-bottom: 10px;
      }
      #fieldStatus {
        padding: 8px;
        background-color: #e6f7ff;
        border-left: 4px solid #1890ff;
        margin: 10px 0;
        word-break: break-all;
        display: none;
      }
      #allValues {
        padding: 8px;
        background-color: #f9f9f9;
        border-left: 4px solid #999;
        margin: 10px 0;
        word-break: break-all;
        display: none;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
      }
      pre {
        white-space: pre-wrap;
        margin: 0;
      }
      .note {
        font-size: 12px;
        color: #666;
        margin-top: 12px;
      }
      ul {
        margin: 5px 0;
        padding-left: 20px;
      }
    </style>
  </head>
  <body>
    <div id="status">Loading‚Ä¶</div>
    <div id="fieldStatus" style="display:none;"></div>
    <div id="allValues" style="display:none;"></div>
    <div class="note">This widget is monitoring checkbox group changes. Check your browser console (F12) for detailed logs.</div>
  </body>
</html>
